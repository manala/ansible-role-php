---

- hosts: all
  tasks:
  - apt_key:
      url: http://www.dotdeb.org/dotdeb.gpg
      id:  89DF5277

- name: Install - Extensions - Wheezy - Php 5.4
  hosts: wheezy
  vars:
    manala_php_version: 5
    manala_php_extensions:
      - intl
      - curl
      - mbstring
      - xml
      - zip
  pre_tasks:
    - apt:
        package: php*
        state:   absent
        purge:   true
    - apt_repository:
        repo: deb http://packages.dotdeb.org wheezy-php55 all
        state: absent
        update_cache: false
    - apt_repository:
        repo: deb http://packages.dotdeb.org wheezy-php56 all
        state: absent
        update_cache: false
    - apt_repository:
        repo: deb http://packages.dotdeb.org wheezy all
  roles:
    - manala.php
  post_tasks:
    - raw: "{{ 'echo \"' ~ item|to_yaml ~ '\"|goss -g - validate' }}"
      with_items:
        - package:
            php5-intl:
              installed: true
            php5-curl:
              installed: true

- name: Install - Extensions - Wheezy - Php 5.5
  hosts: wheezy
  vars:
    manala_php_version: 5
    manala_php_extensions:
      - intl
      - curl
      - mbstring
      - xml
      - zip
  pre_tasks:
    - apt:
        package: php*
        state:   absent
        purge:   true
    - apt_repository:
        repo: deb http://packages.dotdeb.org wheezy all
        state: absent
        update_cache: false
    - apt_repository:
        repo: deb http://packages.dotdeb.org wheezy-php56 all
        state: absent
        update_cache: false
    - apt_repository:
        repo: deb http://packages.dotdeb.org wheezy-php55 all
  roles:
    - manala.php
  post_tasks:
    - raw: "{{ 'echo \"' ~ item|to_yaml ~ '\"|goss -g - validate' }}"
      with_items:
        - package:
            php5-intl:
              installed: true
            php5-curl:
              installed: true

- name: Install - Extensions - Wheezy - Php 5.6
  hosts: wheezy
  vars:
    manala_php_version: 5
    manala_php_extensions:
      - intl
      - curl
      - mbstring
      - xml
      - zip
  pre_tasks:
    - apt:
        package: php*
        state:   absent
        purge:   true
    - apt_repository:
        repo: deb http://packages.dotdeb.org wheezy all
        state: absent
        update_cache: false
    - apt_repository:
        repo: deb http://packages.dotdeb.org wheezy-php55 all
        state: absent
        update_cache: false
    - apt_repository:
        repo: deb http://packages.dotdeb.org wheezy-php56 all
  roles:
    - manala.php
  post_tasks:
    - raw: "{{ 'echo \"' ~ item|to_yaml ~ '\"|goss -g - validate' }}"
      with_items:
        - package:
            php5-intl:
              installed: true
            php5-curl:
              installed: true

- name: Install - Extensions - Jessie - 7.0
  hosts: jessie
  vars:
    manala_php_version: 7.0
    manala_php_extensions:
      - intl
      - curl
      - mbstring
      - xml
      - zip
  pre_tasks:
    - apt:
        package: php*
        state:   absent
        purge:   true
    - apt_repository:
        repo: deb http://packages.dotdeb.org jessie all
  roles:
    - manala.php
  post_tasks:
    - raw: "{{ 'echo \"' ~ item|to_yaml ~ '\"|goss -g - validate' }}"
      with_items:
        - package:
            php7.0-intl:
              installed: true
            php7.0-curl:
              installed: true
            php7.0-mbstring:
              installed: true
            php7.0-xml:
              installed: true
            php7.0-zip:
              installed: true

    # optional attributes
    #stdout:
    #- go version go1.6 linux/amd64
    #stderr: []
    #timeout: 10000 # in milliseconds

    # manala_php_version: "{{ {'wheezy': '5', 'jessie': '7.0'}[ansible_distribution_release] }}"
    #manala_php_sapis:
    #  - fpm
    # manala_php_extensions:
    #   - intl
    #   - curl
    #   - mbstring
    #   - xml
    #   - zip


# # 7
# - cli      # Sapi systématique
# - common   # dépendance des sapis cli et fpm
# - json     # dépendance des sapis cli et fpm
# - opcache  # dépendance des sapis cli et fpm
# - readline # dépendance des sapis cli
# - fpm
# - intl
# - curl
# - mbstring
# - xml
# - zip
#
# # 5
# - cli      # Sapi systématique
# - common   # dépendance des sapis cli et fpm
# - fpm
# - intl
# - curl
