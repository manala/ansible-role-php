---

- name: Blackfire - Wheezy - 5.4
  hosts: wheezy
  vars:
    manala_php_version: 5
    manala_php_blackfire: true
    manala_php_sapis_exclusive: false
    manala_php_sapis:
      - cli
      - sapi:  fpm
        state: present
    manala_php_blackfire_agent_config:
      - server-id: c74906db-43d3-4c96-ab27-010600321b89
      - server-token: 5b78cc7fea3b766ff4ea470178b502c829c09d58ebdc20252e0337db804000e2
    manala_php_blackfire_client_config:
      - client-id: b7bf7d2d-c8c1-4354-82bf-aa403afbc3b3
      - client-token: e7d9ca7e486b67d1f2d9b764fb383340fbd374e20daefa747e8a4fd690d83e7b
  pre_tasks:
    - include: pre_tasks/dotdeb_wheezy.yml
    - include: pre_tasks/blackfire.yml
  roles:
    - manala.php
  post_tasks:
    - pause:
        seconds: 3
    - raw: "{{ 'echo \"' ~ item|to_yaml ~ '\"|goss -g - validate' }}"
      with_items:
        - package:
            blackfire-agent:
              installed: true
            blackfire-php:
              installed: true
        - file:
            /etc/blackfire/agent:
              exists: true
              contains:
                - server-id=c74906db-43d3-4c96-ab27-010600321b89
                - server-token=5b78cc7fea3b766ff4ea470178b502c829c09d58ebdc20252e0337db804000e2
            ~/.blackfire.ini:
              exists: true
              contains:
                - client-id=b7bf7d2d-c8c1-4354-82bf-aa403afbc3b3
                - client-token=e7d9ca7e486b67d1f2d9b764fb383340fbd374e20daefa747e8a4fd690d83e7b
        - service:
            blackfire-agent:
              enabled: true
              running: true
        - command:
            blackfire status:
              exit-status: 0
            php -m:
              exit-status: 0
              stdout:
                - blackfire
            php5-fpm -m:
              exit-status: 0
              stdout:
                - blackfire

- name: Blackfire - Wheezy - 5.5
  hosts: wheezy
  vars:
    manala_php_version: 5
    manala_php_blackfire: true
    manala_php_sapis_exclusive: false
    manala_php_sapis:
      - cli
      - sapi:  fpm
        state: present
    manala_php_blackfire_agent_config:
      - server-id: c74906db-43d3-4c96-ab27-010600321b89
      - server-token: 5b78cc7fea3b766ff4ea470178b502c829c09d58ebdc20252e0337db804000e2
    manala_php_blackfire_client_config:
      - client-id: b7bf7d2d-c8c1-4354-82bf-aa403afbc3b3
      - client-token: e7d9ca7e486b67d1f2d9b764fb383340fbd374e20daefa747e8a4fd690d83e7b
  pre_tasks:
    - include: pre_tasks/dotdeb_wheezy_55.yml
    - include: pre_tasks/blackfire.yml
  roles:
    - manala.php
  post_tasks:
    - pause:
        seconds: 3
    - raw: "{{ 'echo \"' ~ item|to_yaml ~ '\"|goss -g - validate' }}"
      with_items:
        - package:
            blackfire-agent:
              installed: true
            blackfire-php:
              installed: true
        - file:
            /etc/blackfire/agent:
              exists: true
              contains:
                - server-id=c74906db-43d3-4c96-ab27-010600321b89
                - server-token=5b78cc7fea3b766ff4ea470178b502c829c09d58ebdc20252e0337db804000e2
            ~/.blackfire.ini:
              exists: true
              contains:
                - client-id=b7bf7d2d-c8c1-4354-82bf-aa403afbc3b3
                - client-token=e7d9ca7e486b67d1f2d9b764fb383340fbd374e20daefa747e8a4fd690d83e7b
        - service:
            blackfire-agent:
              enabled: true
              running: true
        - command:
            blackfire status:
              exit-status: 0
            php -m:
              exit-status: 0
              stdout:
                - blackfire
            php5-fpm -m:
              exit-status: 0
              stdout:
                - blackfire

- name: Blackfire - Wheezy - 5.6
  hosts: wheezy
  vars:
    manala_php_version: 5
    manala_php_blackfire: true
    manala_php_sapis_exclusive: false
    manala_php_sapis:
      - cli
      - sapi:  fpm
        state: present
    manala_php_blackfire_agent_config:
      - server-id: c74906db-43d3-4c96-ab27-010600321b89
      - server-token: 5b78cc7fea3b766ff4ea470178b502c829c09d58ebdc20252e0337db804000e2
    manala_php_blackfire_client_config:
      - client-id: b7bf7d2d-c8c1-4354-82bf-aa403afbc3b3
      - client-token: e7d9ca7e486b67d1f2d9b764fb383340fbd374e20daefa747e8a4fd690d83e7b
  pre_tasks:
    - include: pre_tasks/dotdeb_wheezy_56.yml
    - include: pre_tasks/blackfire.yml
  roles:
    - manala.php
  post_tasks:
    - pause:
        seconds: 3
    - raw: "{{ 'echo \"' ~ item|to_yaml ~ '\"|goss -g - validate' }}"
      with_items:
        - package:
            blackfire-agent:
              installed: true
            blackfire-php:
              installed: true
        - file:
            /etc/blackfire/agent:
              exists: true
              contains:
                - server-id=c74906db-43d3-4c96-ab27-010600321b89
                - server-token=5b78cc7fea3b766ff4ea470178b502c829c09d58ebdc20252e0337db804000e2
            ~/.blackfire.ini:
              exists: true
              contains:
                - client-id=b7bf7d2d-c8c1-4354-82bf-aa403afbc3b3
                - client-token=e7d9ca7e486b67d1f2d9b764fb383340fbd374e20daefa747e8a4fd690d83e7b
        - service:
            blackfire-agent:
              enabled: true
              running: true
        - command:
            blackfire status:
              exit-status: 0
            php -m:
              exit-status: 0
              stdout:
                - blackfire
            php5-fpm -m:
              exit-status: 0
              stdout:
                - blackfire

- name: Blackfire - Jessie - 7.0
  hosts: jessie
  vars:
    manala_php_version: 7.0
    manala_php_blackfire: true
    manala_php_sapis_exclusive: false
    manala_php_sapis:
      - cli
      - sapi:  fpm
        state: present
    manala_php_blackfire_agent_config:
      - server-id: c74906db-43d3-4c96-ab27-010600321b89
      - server-token: 5b78cc7fea3b766ff4ea470178b502c829c09d58ebdc20252e0337db804000e2
    manala_php_blackfire_client_config:
      - client-id: b7bf7d2d-c8c1-4354-82bf-aa403afbc3b3
      - client-token: e7d9ca7e486b67d1f2d9b764fb383340fbd374e20daefa747e8a4fd690d83e7b
  pre_tasks:
    - include: pre_tasks/dotdeb_jessie.yml
    - include: pre_tasks/blackfire.yml
  roles:
    - manala.php
  post_tasks:
    - pause:
        seconds: 3
    - raw: "{{ 'echo \"' ~ item|to_yaml ~ '\"|goss -g - validate' }}"
      with_items:
        - package:
            blackfire-agent:
              installed: true
            blackfire-php:
              installed: true
        - file:
            /etc/blackfire/agent:
              exists: true
              contains:
                - server-id=c74906db-43d3-4c96-ab27-010600321b89
                - server-token=5b78cc7fea3b766ff4ea470178b502c829c09d58ebdc20252e0337db804000e2
            ~/.blackfire.ini:
              exists: true
              contains:
                - client-id=b7bf7d2d-c8c1-4354-82bf-aa403afbc3b3
                - client-token=e7d9ca7e486b67d1f2d9b764fb383340fbd374e20daefa747e8a4fd690d83e7b
        - service:
            blackfire-agent:
              enabled: true
              running: true
        - command:
            blackfire status:
              exit-status: 0
            php -m:
              exit-status: 0
              stdout:
                - blackfire
            php-fpm7.0 -m:
              exit-status: 0
              stdout:
                - blackfire
